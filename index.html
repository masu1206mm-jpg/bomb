<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ã‚«ãƒƒãƒ—ãƒ«æ°´é¢¨èˆ¹ã‚²ãƒ¼ãƒ ï¼</title>
  <style>
    :root{ --bg:#07122a; --fg:#eaf0ff; --muted:#a8b5e6; --panel:rgba(255,255,255,.08); }
    body{
      margin:0; color:var(--fg);
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN",sans-serif;
      background: radial-gradient(1200px 700px at 50% 10%, #163c8a 0%, var(--bg) 55%, #030713 100%);
    }
    .wrap{ min-height:100vh; display:grid; place-items:center; padding:18px; }
    .card{
      width:min(980px, 100%);
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      overflow:hidden;
    }
    header{ padding:16px 16px 10px; border-bottom:1px solid rgba(255,255,255,.08); }
    h1{ margin:0 0 6px; font-size:26px; }
    .muted{ color:var(--muted); }
    .main{ display:grid; grid-template-columns: 1fr; gap:12px; padding:14px; }
    @media(min-width:980px){ .main{ grid-template-columns: 1fr 320px; } }
    canvas{
      width:100%;
      aspect-ratio: 16/9;
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      display:block;
    }
    .side{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      border-radius:16px;
      padding:12px;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:10px 0; }
    button{
      border:1px solid rgba(255,255,255,.15);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.05));
      color:var(--fg);
      padding:12px 14px;
      border-radius:14px;
      font-size:16px;
      cursor:pointer;
      user-select:none;
    }
    button:hover{ border-color:rgba(255,255,255,.26); }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    .pill{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      font-size:13px;
    }
    .big{ font-weight:800; font-size:20px; }
    .targets{ display:grid; grid-template-columns:1fr; gap:8px; margin-top:10px; }
    .tbtn{ text-align:left; padding:10px; border-radius:14px; }
    .mini{ font-size:12px; color:var(--muted); margin-top:3px; }
    .overlay{
      position:fixed; inset:0; display:grid; place-items:center;
      background: radial-gradient(900px 500px at 50% 20%, rgba(120,180,255,.18), rgba(0,0,0,.78));
      padding:18px;
    }
    .startCard{
      width:min(720px, 100%);
      border:1px solid rgba(255,255,255,.14);
      background: rgba(10,16,40,.72);
      border-radius:20px;
      padding:18px;
      box-shadow: 0 20px 70px rgba(0,0,0,.55);
    }
    .titleBig{ font-size:34px; margin:0 0 10px; font-weight:900; }
    .hot{ font-weight:900; }
    .hint{ margin-top:8px; color:var(--muted); font-size:13px; }
  </style>
</head>
<body>
  <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
  <div class="overlay" id="overlay">
    <div class="startCard">
      <div class="titleBig">ã‚«ãƒƒãƒ—ãƒ«æ°´é¢¨èˆ¹ã‚²ãƒ¼ãƒ ï¼</div>
      <div class="big">çˆ†ç™ºã•ã›ã‚ï¼è‡ªåˆ†ã®é­‚ğŸ”¥</div>
      <p class="muted">
        å…¬åœ’ã§é–‹å‚¬ä¸­ã®æ°´é¢¨èˆ¹ãƒ•ã‚§ã‚¹ï¼æ¬¡ã€…æ¥ã‚‹å‚åŠ è€…ï¼ˆã‚«ãƒƒãƒ—ãƒ«å¤šã‚ï¼‰ã«ã€<b>å·¨å¤§æ°´ã—ã¶ã</b>ã®æ°´é¢¨èˆ¹ã‚’æŠ•ã’ã¦ç››ã‚Šä¸Šã’ã‚ã€‚
        â€»å…¨éƒ¨ãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³ï¼†ãŠç¥­ã‚Šãƒãƒªï¼ˆå±é™ºè¡Œç‚ºã¯ã—ãªã„ã§ã­ï¼‰
      </p>
      <div class="row">
        <button id="startBtn">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <span class="pill">ã‚¹ãƒãƒ›OK / 1ãƒ•ã‚¡ã‚¤ãƒ«</span>
      </div>
      <div class="hint">æ“ä½œï¼šå³ã®ã€ŒæŠ•ã’ã‚‹ã€ãƒœã‚¿ãƒ³ or ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Šã®ç›¸æ‰‹ã‚’ã‚¿ãƒƒãƒ—</div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <header>
        <h1>æ°´é¢¨èˆ¹ãƒ•ã‚§ã‚¹ï¼šã‚­ãƒã‚³é›²ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥</h1>
        <div class="muted">ã‚¿ãƒ¼ãƒ³åˆ¶ã˜ã‚ƒãªãã¦ã€æ¬¡ã€…æ¥ã‚‹ç›¸æ‰‹ã«æŠ•ã’ã‚‹ã‚¹ã‚³ã‚¢ã‚¢ã‚¿ãƒƒã‚¯ã€‚åˆ¶é™æ™‚é–“å†…ã«ä½•å›å½“ã¦ã‚Œã‚‹ã‹ã€‚</div>
      </header>

      <div class="main">
        <canvas id="cv" width="1280" height="720"></canvas>

        <div class="side">
          <div class="row">
            <span class="pill">TIME <b id="time" class="big">30.0</b>s</span>
            <span class="pill">SCORE <b id="score" class="big">0</b></span>
            <span class="pill">HITS <b id="hits" class="big">0</b></span>
          </div>

          <div class="muted">å³ã®å€™è£œã‹ã‚‰ã€Œèª°ã«æŠ•ã’ã‚‹ã‹ã€é¸ã¹ã‚‹ã€‚<br>ï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹ã®ç›¸æ‰‹ã‚’ç›´æ¥ã‚¿ãƒƒãƒ—ã§ã‚‚OKï¼‰</div>

          <div class="targets" id="targets"></div>

          <div class="row" style="margin-top:12px;">
            <button id="pauseBtn">ä¸€æ™‚åœæ­¢</button>
            <button id="resetBtn">ãƒªã‚»ãƒƒãƒˆ</button>
          </div>

          <div class="muted" id="msg" style="margin-top:8px;"></div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');

  const overlay = document.getElementById('overlay');
  const startBtn = document.getElementById('startBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const resetBtn = document.getElementById('resetBtn');

  const timeEl = document.getElementById('time');
  const scoreEl = document.getElementById('score');
  const hitsEl = document.getElementById('hits');
  const targetsEl = document.getElementById('targets');
  const msgEl = document.getElementById('msg');

  // ====== ã‚²ãƒ¼ãƒ è¨­å®š ======
  const GAME_SECONDS = 30;
  const MAX_COUPLES_ON_SCREEN = 3;
  const SPAWN_INTERVAL_MS = 1300; // æ¬¡ã€…ãã‚‹æ„Ÿ
  const WATER_BALLOON_COOLDOWN_MS = 220;

  // å·¨å¤§æ°´ã—ã¶ãï¼ˆåŸçˆ†ãªã¿ï¼æ¯”å–©ï¼‰æ¼”å‡ºãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
  const SPLASH_PARTICLES = 220;
  const SPLASH_SPEED = 15;
  const SPLASH_GRAVITY = 0.22;
  const SPLASH_RING_COUNT = 5;

  // ====== çŠ¶æ…‹ ======
  let running = false;
  let paused = false;
  let score = 0;
  let hits = 0;
  let endAt = 0;
  let lastFrame = 0;
  let lastThrowAt = 0;
  let spawnTimer = 0;

  const couples = [];
  const particles = [];
  const rings = [];
  const clouds = [];

  // ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
  const rnd = (a,b) => a + Math.random()*(b-a);
  const rndi = (a,b) => Math.floor(rnd(a,b+1));
  const pick = arr => arr[Math.floor(Math.random()*arr.length)];

  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

  // é›‘ãªè¦‹ãŸç›®ç”¨ï¼ˆé¡”ãƒ»é«ªãƒ»æœãƒ»å¹´é½¢æ„Ÿï¼‰
  function makePerson(seedX, seedY){
    const ageGroup = pick(["è‹¥è€…","å¤§äºº","ã‚·ãƒ‹ã‚¢"]);
    const style = pick(["ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«","ãã‚Œã„ã‚","ã‚¹ãƒãƒ¼ãƒ†ã‚£","ã‚¹ãƒˆãƒªãƒ¼ãƒˆ","ãƒ•ã‚©ãƒ¼ãƒãƒ«"]);
    const vibe = pick(["ãƒ‹ã‚³ãƒ‹ã‚³","ã‚¯ãƒ¼ãƒ«","ç…§ã‚Œ","å…ƒæ°—","çœ ãã†"]);
    const hair = pick(["ã‚·ãƒ§ãƒ¼ãƒˆ","ãƒŸãƒ‡ã‚£ã‚¢ãƒ ","ãƒ­ãƒ³ã‚°","ãƒ‘ãƒ¼ãƒ","ãƒœãƒ–"]);
    const skin = pick(["æ˜ã‚‹ã‚","ãµã¤ã†","æ—¥ç„¼ã‘"]);
    const outfit = pick(["Tã‚·ãƒ£ãƒ„","ãƒ‘ãƒ¼ã‚«ãƒ¼","ã‚³ãƒ¼ãƒˆ","ã‚·ãƒ£ãƒ„","ãƒ¯ãƒ³ãƒ”","ã‚¸ãƒ£ã‚±ãƒƒãƒˆ"]);
    return { ageGroup, style, vibe, hair, skin, outfit, seedX, seedY };
  }

  function makeCouple(){
    const x = rnd(180, cv.width-180);
    const y = rnd(360, cv.height-120);
    const speed = rnd(0.45, 1.05);
    const dir = Math.random() < 0.5 ? -1 : 1;

    const p1 = makePerson(rnd(0,1), rnd(0,1));
    const p2 = makePerson(rnd(0,1), rnd(0,1));

    const tag = pick(["è€è‹¥ç”·å¥³","å­¦ç”Ÿã£ã½ã„","å¤«å©¦ã£ã½ã„","å‹é”ã‚«ãƒƒãƒ—ãƒ«","è·é›¢è¿‘ã‚","åˆãƒ‡ãƒ¼ãƒˆæ„Ÿ"]);
    const name = `${tag}ã‚«ãƒƒãƒ—ãƒ«`;

    return {
      id: cryptoRandomId(),
      name,
      tag,
      x, y,
      vx: dir * speed,
      w: 220,
      h: 170,
      p1, p2,
      hp: 1, // 1 hit = splash
      alive: true
    };
  }

  function cryptoRandomId(){
    // iOS Safariã§ã‚‚å‹•ãã‚„ã¤
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function reset(){
    running = false;
    paused = false;
    score = 0;
    hits = 0;
    couples.length = 0;
    particles.length = 0;
    rings.length = 0;
    clouds.length = 0;
    spawnTimer = 0;
    lastThrowAt = 0;
    msgEl.textContent = "";
    updateUI();
    draw();
  }

  function start(){
    reset();
    running = true;
    paused = false;
    endAt = performance.now() + GAME_SECONDS*1000;
    lastFrame = performance.now();
    overlay.style.display = "none";
    msgEl.textContent = "æ°´é¢¨èˆ¹ãƒ•ã‚§ã‚¹é–‹å§‹ï¼æ´¾æ‰‹ã«ã„ã‘ï¼";
    // å…ˆã«3çµ„ç½®ã
    while(couples.length < MAX_COUPLES_ON_SCREEN) couples.push(makeCouple());
    rebuildTargets();
    requestAnimationFrame(loop);
  }

  function updateUI(){
    scoreEl.textContent = String(score);
    hitsEl.textContent = String(hits);
  }

  // ====== æç”» ======
  function drawBackground(){
    // ç©º
    const g = ctx.createLinearGradient(0,0,0,cv.height);
    g.addColorStop(0, "rgba(90,150,255,0.35)");
    g.addColorStop(0.35, "rgba(25,55,130,0.20)");
    g.addColorStop(1, "rgba(0,0,0,0.20)");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,cv.width,cv.height);

    // åœ°é¢
    ctx.fillStyle = "rgba(20,120,70,0.35)";
    ctx.fillRect(0, cv.height*0.62, cv.width, cv.height*0.38);

    // å…¬åœ’ã£ã½ã„æœ¨ï¼ˆé›‘ï¼‰
    for(let i=0;i<6;i++){
      const x = (i+1)*cv.width/7 + Math.sin(performance.now()/2000 + i)*8;
      const y = cv.height*0.62;
      ctx.fillStyle = "rgba(40,120,60,0.35)";
      ctx.beginPath();
      ctx.arc(x, y-80, 55, 0, Math.PI*2);
      ctx.arc(x-45, y-65, 45, 0, Math.PI*2);
      ctx.arc(x+45, y-65, 45, 0, Math.PI*2);
      ctx.fill();
      ctx.fillStyle = "rgba(120,80,40,0.35)";
      ctx.fillRect(x-10, y-60, 20, 70);
    }
  }

  function drawPerson(px, py, person){
    // ä½“ï¼ˆé›‘ãªäººå‹ï¼‰
    const headR = 18 + (person.ageGroup==="ã‚·ãƒ‹ã‚¢"?2:0);
    const bodyH = 52 + (person.ageGroup==="è‹¥è€…"?4:0);
    const bodyW = 22;

    // å½±
    ctx.fillStyle = "rgba(0,0,0,0.25)";
    ctx.beginPath();
    ctx.ellipse(px, py+70, 26, 10, 0, 0, Math.PI*2);
    ctx.fill();

    // ä½“
    ctx.fillStyle = "rgba(255,255,255,0.20)";
    ctx.fillRect(px-bodyW/2, py+18, bodyW, bodyH);

    // è…•
    ctx.strokeStyle = "rgba(255,255,255,0.22)";
    ctx.lineWidth = 5;
    ctx.beginPath();
    ctx.moveTo(px-bodyW/2, py+35);
    ctx.lineTo(px-bodyW/2-14, py+55);
    ctx.moveTo(px+bodyW/2, py+35);
    ctx.lineTo(px+bodyW/2+14, py+55);
    ctx.stroke();

    // é ­
    ctx.fillStyle = "rgba(255,230,200,0.55)";
    ctx.beginPath();
    ctx.arc(px, py, headR, 0, Math.PI*2);
    ctx.fill();

    // é«ª
    ctx.fillStyle = "rgba(30,30,30,0.35)";
    ctx.beginPath();
    ctx.arc(px, py-4, headR, Math.PI, 0);
    ctx.fill();

    // é¡”ï¼ˆé›‘ï¼‰
    ctx.fillStyle = "rgba(0,0,0,0.35)";
    ctx.beginPath();
    ctx.arc(px-6, py, 2, 0, Math.PI*2);
    ctx.arc(px+6, py, 2, 0, Math.PI*2);
    ctx.fill();
    ctx.strokeStyle = "rgba(0,0,0,0.25)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(px, py+6, 7, 0, Math.PI);
    ctx.stroke();
  }

  function drawCouple(c){
    // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã®é€æ˜æ ï¼ˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ„Ÿï¼‰
    ctx.fillStyle = "rgba(255,255,255,0.05)";
    ctx.strokeStyle = "rgba(255,255,255,0.15)";
    ctx.lineWidth = 2;
    roundRect(ctx, c.x-c.w/2, c.y-c.h/2, c.w, c.h, 14, true, true);

    // ãƒ™ãƒ³ãƒã£ã½ã„
    ctx.fillStyle = "rgba(90,60,40,0.28)";
    ctx.fillRect(c.x-85, c.y+45, 170, 14);
    ctx.fillRect(c.x-75, c.y+59, 12, 18);
    ctx.fillRect(c.x+63, c.y+59, 12, 18);

    // äºº2äºº
    drawPerson(c.x-45, c.y-10, c.p1);
    drawPerson(c.x+45, c.y-10, c.p2);

    // ãƒ©ãƒ™ãƒ«
    ctx.fillStyle = "rgba(0,0,0,0.35)";
    ctx.fillRect(c.x-c.w/2+10, c.y-c.h/2+10, c.w-20, 26);
    ctx.fillStyle = "rgba(255,255,255,0.85)";
    ctx.font = "16px system-ui, -apple-system, sans-serif";
    ctx.fillText(c.name, c.x-c.w/2+16, c.y-c.h/2+29);
  }

  function roundRect(ctx, x, y, w, h, r, fill, stroke){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
    if(fill) ctx.fill();
    if(stroke) ctx.stroke();
  }

  function drawEffects(){
    // ã‚­ãƒã‚³é›²ã£ã½ã„æ°´è’¸æ°—ï¼ˆã‚‚ã¡ã‚ã‚“æ°´ã®æ¼”å‡ºï¼‰
    for(const cl of clouds){
      ctx.save();
      ctx.globalAlpha = cl.a;
      ctx.fillStyle = "rgba(170,220,255,0.20)";
      ctx.beginPath();
      ctx.arc(cl.x, cl.y, cl.r, 0, Math.PI*2);
      ctx.fill();
      ctx.restore();
    }

    // ãƒªãƒ³ã‚°æ³¢
    for(const r of rings){
      ctx.save();
      ctx.globalAlpha = r.a;
      ctx.strokeStyle = "rgba(120,210,255,0.65)";
      ctx.lineWidth = r.w;
      ctx.beginPath();
      ctx.arc(r.x, r.y, r.rad, 0, Math.PI*2);
      ctx.stroke();
      ctx.restore();
    }

    // æ°´ã—ã¶ãç²’
    for(const p of particles){
      ctx.save();
      ctx.globalAlpha = p.a;
      ctx.fillStyle = "rgba(120,220,255,0.85)";
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      ctx.fill();
      ctx.restore();
    }
  }

  function drawHUD(){
    // ç”»é¢å†…ã«ã€Œã‚¿ãƒƒãƒ—ã§æŠ•ã’ã‚‹ã€è»½ãå‡ºã™
    ctx.fillStyle = "rgba(0,0,0,0.28)";
    ctx.fillRect(12, 12, 360, 36);
    ctx.fillStyle = "rgba(255,255,255,0.85)";
    ctx.font = "16px system-ui, -apple-system, sans-serif";
    ctx.fillText("ç›¸æ‰‹ã‚’ã‚¿ãƒƒãƒ— â†’ æ°´é¢¨èˆ¹æŠ•ã’ã‚‹ï¼ˆå·¨å¤§ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ï¼‰", 20, 36);
  }

  function draw(){
    ctx.clearRect(0,0,cv.width,cv.height);
    drawBackground();

    // å¥¥â†’æ‰‹å‰é †
    for(const c of couples) if(c.alive) drawCouple(c);
    drawEffects();
    drawHUD();
  }

  // ====== ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ ======
  function rebuildTargets(){
    targetsEl.innerHTML = "";
    couples.forEach((c, idx) => {
      const btn = document.createElement("button");
      btn.className = "tbtn";
      btn.innerHTML = `<div class="big">ğŸ¯ ${idx+1}. ${c.name}</div>
                       <div class="mini">é›°å›²æ°—: ${c.tag} / æœ: ${c.p1.outfit} & ${c.p2.outfit}</div>`;
      btn.onclick = () => throwBalloonAt(c.x, c.y, c);
      targetsEl.appendChild(btn);
    });
  }

  function spawnIfNeeded(dt){
    spawnTimer += dt;
    if(spawnTimer >= SPAWN_INTERVAL_MS){
      spawnTimer = 0;
      // ç”»é¢ã«ã„ã‚‹æ•°ã‚’ä¿ã¤
      while(couples.length < MAX_COUPLES_ON_SCREEN){
        couples.push(makeCouple());
      }
      rebuildTargets();
    }
  }

  function moveCouples(dt){
    const k = dt/16.67;
    for(const c of couples){
      c.x += c.vx * k;
      if(c.x < 170){ c.x = 170; c.vx *= -1; }
      if(c.x > cv.width-170){ c.x = cv.width-170; c.vx *= -1; }
    }
  }

  function throwBalloonAt(x, y, target){
    if(!running || paused) return;
    const now = performance.now();
    if(now - lastThrowAt < WATER_BALLOON_COOLDOWN_MS) return;
    lastThrowAt = now;

    // å½“ãŸã‚Šåˆ¤å®šï¼ˆå¯¾è±¡ã®æ å†…ãªã‚‰HITã€å¤–ãªã‚‰MISSï¼‰
    let hit = false;
    if(target){
      hit = pointInRect(x, y, target.x-target.w/2, target.y-target.h/2, target.w, target.h);
    } else {
      // ã‚¿ãƒƒãƒ—ä½ç½®ã‹ã‚‰ä¸€ç•ªè¿‘ã„ã‚«ãƒƒãƒ—ãƒ«ã«å¯¾ã—ã¦åˆ¤å®š
      const nearest = findNearestCouple(x,y);
      if(nearest){
        hit = pointInRect(x, y, nearest.x-nearest.w/2, nearest.y-nearest.h/2, nearest.w, nearest.h);
        target = nearest;
      }
    }

    if(hit && target){
      hits++;
      score += 120;

      // ãƒ‰æ´¾æ‰‹ãªæ°´ã—ã¶ãï¼ˆã‚­ãƒã‚³é›²é¢¨ï¼‰
      megaSplash(target.x, target.y-10);

      // ä¸€ç¬ã§æ¬¡ã®ã‚«ãƒƒãƒ—ãƒ«ã«å…¥ã‚Œæ›¿ãˆ
      const idx = couples.findIndex(c => c.id === target.id);
      if(idx >= 0){
        couples.splice(idx, 1);
        couples.push(makeCouple());
        rebuildTargets();
      }
      msgEl.textContent = "HITï¼å·¨å¤§ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ï¼ğŸ’¦";
    } else {
      score = Math.max(0, score - 20);
      smallSplash(x, y);
      msgEl.textContent = "MISSâ€¦ æ¬¡ã„ã“ï¼";
    }
    updateUI();
  }

  function pointInRect(px, py, x, y, w, h){
    return (px>=x && px<=x+w && py>=y && py<=y+h);
  }

  function findNearestCouple(x,y){
    let best = null, bestD = 1e18;
    for(const c of couples){
      const dx = c.x-x, dy = c.y-y;
      const d = dx*dx + dy*dy;
      if(d < bestD){ bestD = d; best = c; }
    }
    return best;
  }

  function smallSplash(x,y){
    for(let i=0;i<40;i++){
      particles.push({
        x, y,
        vx: rnd(-6,6),
        vy: rnd(-10,-2),
        r: rnd(1.6,3.4),
        a: 1
      });
    }
    rings.push({ x, y, rad: 10, a: 0.7, w: 3 });
  }

  function megaSplash(x,y){
    // ä¸­å¿ƒã®ãƒªãƒ³ã‚°æ³¢ã‚’è¤‡æ•°
    for(let i=0;i<SPLASH_RING_COUNT;i++){
      rings.push({ x, y: y+30, rad: 20+i*18, a: 0.75 - i*0.10, w: 4-i*0.4 });
    }

    // æ°´ã—ã¶ãç²’å­ï¼ˆå¤§é‡ï¼‰
    for(let i=0;i<SPLASH_PARTICLES;i++){
      const ang = rnd(-Math.PI, 0); // ä¸Šæ–¹å‘ã«é£›ã°ã™
      const sp = rnd(4, SPLASH_SPEED) * (i%7===0 ? 1.3 : 1);
      particles.push({
        x: x + rnd(-6,6),
        y: y + rnd(-6,6),
        vx: Math.cos(ang)*sp + rnd(-1.2,1.2),
        vy: Math.sin(ang)*sp + rnd(-1.2,1.2),
        r: rnd(1.8, 4.6),
        a: 1
      });
    }

    // ã‚­ãƒã‚³é›²ã£ã½ã„â€œæ°´è’¸æ°—â€é›²ï¼ˆã‚‚ã¡ã‚ã‚“æ¯”å–©ï¼‰
    for(let i=0;i<24;i++){
      const up = i<8 ? 1 : 0;
      clouds.push({
        x: x + rnd(-60,60),
        y: y - 10 - i*8 + rnd(-10,10),
        r: rnd(18, 48) * (up?1.25:1.0),
        a: rnd(0.10, 0.22)
      });
    }
  }

  function updateEffects(dt){
    const k = dt/16.67;

    // ç²’å­
    for(let i=particles.length-1;i>=0;i--){
      const p = particles[i];
      p.vy += SPLASH_GRAVITY * k;
      p.x += p.vx * k;
      p.y += p.vy * k;
      p.a -= 0.012 * k;
      p.r *= (1 - 0.0018*k);

      if(p.y > cv.height || p.a <= 0 || p.r < 0.5) particles.splice(i,1);
    }

    // ãƒªãƒ³ã‚°
    for(let i=rings.length-1;i>=0;i--){
      const r = rings[i];
      r.rad += 10*k;
      r.a -= 0.018*k;
      if(r.a <= 0) rings.splice(i,1);
    }

    // é›²
    for(let i=clouds.length-1;i>=0;i--){
      const c = clouds[i];
      c.y -= 0.35*k;
      c.r += 0.22*k;
      c.a -= 0.0028*k;
      if(c.a <= 0) clouds.splice(i,1);
    }
  }

  // ====== ãƒ«ãƒ¼ãƒ— ======
  function loop(now){
    if(!running) return;
    const dt = clamp(now - lastFrame, 0, 50);
    lastFrame = now;

    if(!paused){
      const remain = (endAt - now)/1000;
      if(remain <= 0){
        timeEl.textContent = "0.0";
        running = false;
        paused = false;
        msgEl.textContent = `çµ‚äº†ï¼ SCORE=${score} / HITS=${hits} ğŸ’¦`;
        overlay.style.display = "grid";
        // overlayã®æ–‡è¨€ã‚’å¤‰ãˆãšã€Startã§å†é–‹ã§ãã‚‹
        return;
      }
      timeEl.textContent = remain.toFixed(1);

      spawnIfNeeded(dt);
      moveCouples(dt);
      updateEffects(dt);
      updateUI();
      draw();
    }

    requestAnimationFrame(loop);
  }

  // ====== å…¥åŠ› ======
  function canvasToWorld(ev){
    const rect = cv.getBoundingClientRect();
    const x = (ev.clientX - rect.left) * (cv.width / rect.width);
    const y = (ev.clientY - rect.top) * (cv.height / rect.height);
    return {x,y};
  }

  cv.addEventListener('pointerdown', (ev) => {
    const {x,y} = canvasToWorld(ev);
    // ã‚¿ãƒƒãƒ—ä½ç½®ã«ä¸€ç•ªè¿‘ã„ã‚«ãƒƒãƒ—ãƒ«ã¸æŠ•ã’ã‚‹ï¼ˆå½“ãŸã‚‰ãªã„ã“ã¨ã‚‚ã‚ã‚‹ï¼‰
    const target = findNearestCouple(x,y);
    throwBalloonAt(x,y,target);
  });

  startBtn.addEventListener('click', start);

  pauseBtn.addEventListener('click', () => {
    if(!running) return;
    paused = !paused;
    pauseBtn.textContent = paused ? "å†é–‹" : "ä¸€æ™‚åœæ­¢";
    msgEl.textContent = paused ? "ä¸€æ™‚åœæ­¢ä¸­" : "å†é–‹ï¼";
    if(!paused) requestAnimationFrame(loop);
  });

  resetBtn.addEventListener('click', () => {
    reset();
    overlay.style.display = "grid";
    pauseBtn.textContent = "ä¸€æ™‚åœæ­¢";
  });

  // åˆæœŸè¡¨ç¤º
  reset();
  draw();
})();
</script>
</body>
</html>
